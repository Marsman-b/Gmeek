{% extends 'base.html' %}

{% block head %}
<meta name="description" content="{{ blogBase['description'] }}">
<meta property="og:title" content="{{ blogBase['postTitle'] }}">
<meta property="og:description" content="{{ blogBase['description'] }}">
<meta property="og:type" content="article">
<meta property="og:url" content="{{ blogBase['postUrl'] }}">
<meta property="og:image" content="{{ blogBase['ogImage'] }}">
<title>{{ blogBase['postTitle'] }}</title>
{% if blogBase['highlight']==1 %}
<link href="//unpkg.com/@wooorm/starry-night@2.1.1/style/both.css" rel="stylesheet" />
{% endif %}
{{ blogBase['head'] }}
{% endblock %}

{% block style %}
<style>
/* ===== 原有样式 ===== */
.postTitle{margin:auto 0;font-size:40px;font-weight:bold;}
.title-right{display:flex;margin:auto 0 0 auto;}
.title-right .circle{padding:14px 16px;margin-right:8px;}
#postBody{border-bottom:1px solid var(--color-border-default);padding-bottom:36px;}
#postBody hr{height:2px;}
#cmButton{height:48px;margin-top:48px;}
#comments{margin-top:64px;}
.g-emoji{font-size:24px;}

@media (max-width:600px){
    body{padding:8px;}
    .postTitle{font-size:24px;}
}

{% if blogBase['highlight']!=0 %}
.copy-feedback{
    display:none;
    position:absolute;
    top:10px;
    right:50px;
    color:var(--color-fg-on-emphasis);
    background-color:var(--color-fg-muted);
    border-radius:3px;
    padding:5px 8px;
    font-size:12px;
}
{% endif %}

/* ===================== */
/* ===== 目录布局 ===== */
/* ===================== */

.post-container{
    display:flex;
    gap:20px;
    max-width:1200px;
    margin:0 auto;
}

.post-main{
    flex:1;
    min-width:0;
}

/* 左侧目录 */
.toc-sidebar{
    position:sticky;
    top:20px;
    width:250px;
    height:fit-content;
    background:var(--color-canvas-subtle);
    border:1px solid var(--borderColor-muted, var(--color-border-muted));
    border-radius:8px;
    padding:16px;
    transition:margin-left .3s ease;
}

.toc-header{
    font-weight:bold;
    margin-bottom:12px;
    border-bottom:1px solid var(--borderColor-muted, var(--color-border-muted));
    padding-bottom:8px;
}

.toc-list{
    list-style:none;
    padding:0;
    margin:0;
}

.toc-item{margin:4px 0;}

.toc-link{
    display:block;
    padding:4px 8px;
    text-decoration:none;
    color:var(--color-fg-muted);
    font-size:14px;
    border-radius:4px;
    transition:.2s;
}

.toc-link:hover{
    background:var(--color-neutral-muted);
    color:var(--color-fg-default);
}

.toc-link.active{
    background:var(--color-accent-subtle);
    color:var(--color-accent-emphasis);
    font-weight:500;
}

.toc-h1{font-weight:600;}
.toc-h2{padding-left:16px;}
.toc-h3{padding-left:32px;}
.toc-h4{padding-left:48px;}
.toc-h5{padding-left:64px;}
.toc-h6{padding-left:80px;}

/* 移动端抽屉 */
.toc-toggle{
    position:fixed;
    top:100px;
    left:20px;
    z-index:1000;
    background:var(--color-btn-bg);
    border:1px solid var(--borderColor-muted, var(--color-border-muted));
    border-radius:6px;
    padding:8px 10px;
    cursor:pointer;
    display:none;
}

@media (max-width:1000px){
    .post-container{display:block;}
    .toc-sidebar{
        position:fixed;
        top:0;
        left:0;
        width:280px;
        height:100vh;
        margin-left:-280px;
        z-index:999;
        background:var(--color-canvas-default);
        border-right:1px solid var(--borderColor-muted, var(--color-border-muted));
        border-radius:0;
        box-shadow:2px 0 8px rgba(0,0,0,.1);
        overflow-y:auto;
    }
    .toc-sidebar.visible{margin-left:0;}
    .toc-toggle{display:block;}
}

</style>

{{ blogBase['style'] }}
{% endblock %}

{% block header %}
<h1 class="postTitle">{{ blogBase['postTitle'] }}</h1>
<div class="title-right">
    <a href="{{ blogBase['homeUrl'] }}" class="btn btn-invisible circle" title="{{ i18n['home'] }}">
        <svg class="octicon" width="16" height="16"><path id="pathHome"></path></svg>
    </a>

    {% if blogBase['showPostSource']==1 %}
    <a href="{{ blogBase['postSourceUrl'] }}" target="_blank" class="btn btn-invisible circle" title="Issue">
        <svg class="octicon" width="16" height="16"><path id="pathIssue"></path></svg>
    </a>
    {% endif %}

    <a class="btn btn-invisible circle" onclick="modeSwitch();" title="{{ i18n['switchTheme'] }}"
       {% if blogBase['themeMode']=='fix' %}style="display:none;"{% endif %}>
        <svg class="octicon" width="16" height="16"><path id="themeSwitch"></path></svg>
    </a>
</div>
{% endblock %}

{% block content %}
<button class="toc-toggle" onclick="document.querySelector('.toc-sidebar').classList.toggle('visible')">
☰ 目录
</button>

<div class="post-container">

    <aside class="toc-sidebar">
        <div class="toc-header">目录</div>
        <ul class="toc-list" id="toc"></ul>
    </aside>

    <div class="post-main">
        <div class="markdown-body" id="postBody">
            {{ blogBase['postBody'] }}
        </div>

        <div style="font-size:small;margin-top:8px;float:right;">
            {{ blogBase['bottomText'] }}
        </div>

        {% if blogBase['needComment']==1 %}
        <button class="btn btn-block" type="button" onclick="openComments()" id="cmButton">
            {{ i18n['comments'] }}
        </button>
        <div class="comments" id="comments"></div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block script %}
<script>
document.getElementById("pathHome").setAttribute("d",IconList["home"]);
{% if blogBase['showPostSource']==1 %}
document.getElementById("pathIssue").setAttribute("d",IconList["github"]);
{% endif %}
</script>

<script>
/* ===== 自动生成目录 ===== */
document.addEventListener("DOMContentLoaded", () => {
    const content = document.getElementById("postBody");
    const toc = document.getElementById("toc");
    if (!content || !toc) return;

    const headings = content.querySelectorAll("h1,h2,h3,h4,h5,h6");
    if (!headings.length) return;

    headings.forEach((h, i) => {
        if (!h.id) h.id = "heading-" + i;

        const li = document.createElement("li");
        li.className = "toc-item";

        const a = document.createElement("a");
        a.className = "toc-link toc-" + h.tagName.toLowerCase();
        a.textContent = h.textContent;
        a.href = "#" + h.id;

        li.appendChild(a);
        toc.appendChild(li);
    });

    const observer = new IntersectionObserver(entries => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                document.querySelectorAll(".toc-link").forEach(a => a.classList.remove("active"));
                const active = document.querySelector('.toc-link[href="#' + entry.target.id + '"]');
                if (active) active.classList.add("active");
            }
        });
    }, { rootMargin: "-30% 0px -60% 0px" });

    headings.forEach(h => observer.observe(h));
});
</script>

{{ blogBase['script'] }}
{% endblock %}
